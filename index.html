<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Internal Affairs Dashboard â€” Advanced Red Theme</title>
<style>
  /* Your original styles here (kept as is for brevity) */
  /* Fonts & Reset */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #fff5f5;
    color: #3a0b0b;
    line-height: 1.5;
    min-height: 100vh;
    padding: 1rem;
  }
  h1, h2 {
    color: #8b0000;
    margin-bottom: 0.3rem;
  }
  h1 {
    font-size: 2rem;
    text-align: center;
    font-weight: 700;
  }
  h2 {
    font-size: 1.4rem;
    border-bottom: 2px solid #b22222;
    padding-bottom: 0.2rem;
  }
  .container {
    max-width: 900px;
    margin: 0 auto 3rem;
    background: #ffe5e5;
    border-radius: 15px;
    padding: 1.5rem 2rem;
    box-shadow: 0 4px 15px rgba(139,0,0,0.25);
  }
  button {
    cursor: pointer;
    background-color: #b22222;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 10px;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover {
    background-color: #8b0000;
  }
  input[type="text"], input[type="date"], select, textarea {
    font-size: 1rem;
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
    border: 1.5px solid #b22222;
    width: 100%;
    margin-top: 0.3rem;
    margin-bottom: 1rem;
    outline-offset: 2px;
  }
  input[type="checkbox"] {
    transform: scale(1.3);
    margin-right: 0.5rem;
    cursor: pointer;
  }
  label {
    font-weight: 600;
  }
  .progress-container {
    background: #f9d6d6;
    border-radius: 20px;
    height: 25px;
    overflow: hidden;
    margin-bottom: 1rem;
    box-shadow: inset 0 2px 4px #aa4b4b;
  }
  .progress-bar {
    background: #b22222;
    height: 100%;
    width: 0%;
    transition: width 0.5s ease-in-out;
    border-radius: 20px 0 0 20px;
  }
  .progress-text {
    text-align: center;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #660000;
    font-size: 1.1rem;
  }
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 12px;
  }
  thead tr {
    background-color: #8b0000;
    color: white;
    font-weight: 700;
    border-radius: 12px;
  }
  thead th {
    padding: 0.8rem 0.5rem;
    text-align: left;
  }
  tbody tr {
    background: #fff0f0;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(178,34,34,0.15);
  }
  tbody td {
    padding: 0.8rem 0.5rem;
    vertical-align: middle;
  }
  tbody td button {
    background: #cc4444;
    font-size: 0.9rem;
    padding: 0.3rem 0.8rem;
    border-radius: 8px;
  }
  tbody td button:hover {
    background: #a53030;
  }
  .badge {
    padding: 0.3rem 0.7rem;
    border-radius: 15px;
    font-weight: 700;
    color: white;
    display: inline-block;
    min-width: 80px;
    text-align: center;
    user-select: none;
  }
  .open { background: #dc3545; }
  .pending { background: #fd7e14; }
  .resolved { background: #28a745; }
  .closed { background: #6c757d; }
  .overdue { background: #b22222; }
  .followup { background: #c82333; }
  @media (max-width: 650px) {
    table, thead, tbody, tr, th, td {
      display: block;
      width: 100%;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1.2rem;
      border-radius: 15px;
      box-shadow: 0 3px 15px rgba(178,34,34,0.3);
      background: #ffe5e5;
      padding: 1rem;
    }
    tbody td {
      padding: 0.3rem 0;
      position: relative;
      padding-left: 45%;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #b22222;
    }
    tbody td::before {
      content: attr(data-label);
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      font-weight: 700;
      color: #8b0000;
      white-space: nowrap;
    }
    tbody td button {
      margin-top: 0.8rem;
      width: 100%;
    }
  }
  form {
    background: #ffe5e5;
    border-radius: 15px;
    padding: 1rem 1.5rem;
    box-shadow: inset 0 0 10px #b22222;
    margin-top: 1.5rem;
  }
  form > div {
    margin-bottom: 1rem;
  }
  .officer-list {
    margin-top: 1rem;
    padding: 0;
    list-style: none;
  }
  .officer-list li {
    background: #b22222;
    color: white;
    margin-bottom: 0.6rem;
    padding: 0.4rem 0.7rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .officer-list li button {
    background: #8b0000;
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
  }
  .breakdown {
    margin-top: 1rem;
  }
  .breakdown-item {
    margin-bottom: 0.8rem;
  }
  .breakdown-label {
    font-weight: 700;
    margin-bottom: 0.2rem;
    color: #660000;
  }
  .breakdown-bar {
    height: 20px;
    background: #b22222;
    border-radius: 12px;
    width: 0;
    transition: width 0.5s ease;
  }
  .alert {
    background: #ffe0e0;
    border: 1.5px solid #b22222;
    color: #660000;
    padding: 0.6rem 1rem;
    border-radius: 12px;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  footer {
    text-align: center;
    color: #8b0000;
    font-size: 0.85rem;
    margin-top: 3rem;
  }

  /* Login form styles */
  #login-container {
    max-width: 400px;
    margin: 3rem auto;
    background: #ffe5e5;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(139,0,0,0.25);
    text-align: center;
  }
  #login-container h2 {
    margin-bottom: 1rem;
  }
  #login-container input {
    margin-bottom: 1rem;
  }
  #logout-btn {
    margin-top: 1rem;
  }
</style>
</head>
<body>

<!-- LOGIN FORM (shows if NOT logged in) -->
<div id="login-container" aria-label="Login form" style="display:none;">
  <h2>Internal Affairs Login</h2>
  <form id="login-form">
    <label for="login-username">Username</label><br />
    <input type="text" id="login-username" name="username" required autocomplete="username" /><br />
    <label for="login-password">Password</label><br />
    <input type="password" id="login-password" name="password" required autocomplete="current-password" /><br />
    <button type="submit">Log In</button>
  </form>
  <div id="login-error" role="alert" style="color:#b22222; margin-top:10px;"></div>
</div>

<!-- MAIN APP (shows if logged in) -->
<div id="app" style="display:none;">
  <h1>[![IMG-0489.jpg](https://i.postimg.cc/LXHxXcKz/IMG-0489.jpg)](https://postimg.cc/rdP1ZYpm)  
Internal Affairs Dashboard</h1>

  <button id="logout-btn" style="float:right; background:#8b0000;">Log Out</button>

  <div class="container" aria-label="Progress overview">
    <h2>Progress Overview</h2>
    <div class="progress-text" id="progress-text">Loading progress...</div>
    <div class="progress-container" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Case completion progress">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <div class="container" aria-label="Cases management">
    <h2>Cases</h2>

    <!-- Search and Filter -->
    <div style="margin-bottom:1rem;">
      <input type="text" id="case-search" placeholder="Search cases..." style="width:40%; padding:0.3rem; margin-right:1rem;" aria-label="Search cases" />
      <select id="filter-type" aria-label="Filter by type">
        <option value="">All Types</option>
        <option value="Abuse of Power">Abuse of Power</option>
        <option value="Misconduct">Misconduct</option>
        <option value="Corruption">Corruption</option>
        <option value="Other">Other</option>
        <option value="Blackreport">Blackreport</option>
      </select>
      <select id="filter-status" aria-label="Filter by status" style="margin-left:1rem;">
        <option value="">All Statuses</option>
        <option value="Open">Open</option>
        <option value="Pending">Pending</option>
        <option value="Resolved">Resolved</option>
        <option value="Closed">Closed</option>
      </select>
      <select id="filter-officer" aria-label="Filter by officer" style="margin-left:1rem;">
        <option value="">All Officers</option>
      </select>
      <button id="clear-filters" style="margin-left:1rem; background:#660000;">Clear</button>
    </div>

    <table aria-describedby="cases-desc" aria-live="polite" id="cases-table" role="table">
      <caption id="cases-desc" class="sr-only">List of Internal Affairs cases with details</caption>
      <thead>
        <tr>
          <th scope="col">Case ID</th>
          <th scope="col">Type</th>
          <th scope="col">Status</th>
          <th scope="col">Assigned Officer</th>
          <th scope="col">Due Date</th>
          <th scope="col">Follow-up</th>
          <th scope="col" style="width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody id="cases-tbody">
        <!-- Rows populated by JS -->
      </tbody>
    </table>

    <form id="case-form" aria-label="Add or update a case">
      <h3 id="form-title">Add New Case</h3>
      <input type="hidden" id="edit-index" value="-1" />
      <div>
        <label for="case-id">Case ID</label>
        <input type="text" id="case-id" placeholder="E.g. IA-010" required maxlength="10" />
      </div>
      <div>
        <label for="case-type">Type</label>
        <select id="case-type" required>
          <option value="">Select type</option>
          <option value="Abuse of Power">Abuse of Power</option>
          <option value="Misconduct">Misconduct</option>
          <option value="Corruption">Corruption</option>
          <option value="Other">Other</option>
          <option value="Blackreport">Blackreport</option>
        </select>
      </div>
      <div>
        <label for="case-status">Status</label>
        <select id="case-status" required>
          <option value="">Select status</option>
          <option value="Open">Open</option>
          <option value="Pending">Pending</option>
          <option value="Resolved">Resolved</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div>
        <label for="case-officer">Assigned Officer</label>
        <input type="text" id="case-officer" placeholder="Officer name" required maxlength="30" />
      </div>
      <div>
        <label for="case-due">Due Date</label>
        <input type="date" id="case-due" required />
      </div>
      <div>
        <label><input type="checkbox" id="case-followup" /> Follow-up Required</label>
      </div>

      <!-- Blackreport extra fields -->
      <div id="blackreport-fields" style="display:none; margin-top: 1rem;">
        <div>
          <label for="case-ban-duration">Ban Duration (days)</label>
          <input type="number" id="case-ban-duration" min="1" max="365" />
        </div>
        <div>
          <label for="case-severity">Severity</label>
          <select id="case-severity">
            <option value="">Select severity</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
      </div>

      <button type="submit" id="form-submit">Add Case</button>
      <button type="button" id="form-cancel" style="display:none; margin-left: 10px; background:#660000;">Cancel Edit</button>
    </form>
  </div>

  <div class="container" aria-label="Case type breakdown">
    <h2>Case Breakdown by Type</h2>
    <div id="breakdown-container" class="breakdown" aria-live="polite" aria-atomic="true"></div>
  </div>

  <div class="container" aria-label="Officer management">
    <h2>Officers</h2>
    <ul id="officer-list" class="officer-list" aria-live="polite" aria-atomic="true"></ul>
    <form id="officer-form" aria-label="Add new officer" style="margin-top:1rem;">
      <label for="officer-name">Add Officer</label>
      <input type="text" id="officer-name" placeholder="Officer name" maxlength="30" required />
      <button type="submit">Add Officer</button>
    </form>
  </div>

  <div class="container" aria-label="Leaderboard">
    <h2>Officers Leaderboard</h2>
    <table id="leaderboard-table" style="width:100%; border-collapse: collapse;">
      <thead style="background:#8b0000; color:white;">
        <tr>
          <th>Officer</th>
          <th>Assigned Cases</th>
          <th>Completed Cases</th>
          <th>Efficiency</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <footer>
    <p>Advanced Internal Affairs Dashboard â€” Red Theme UI/UX</p>
    <p>
      Data stored locally on your browser.<br />
      Refresh page to reset data.<br />
    </p>
  </footer>
</div>

<script>
  // --- LOGIN MODULE ---
  const LoginModule = (() => {
    const USERNAME = 'IADirector';
    const PASSWORD = 'IADirector1';
    const STORAGE_KEY = 'ia_login';

    function authenticate(username, password) {
      if (username === USERNAME && password === PASSWORD) {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({ loggedIn: true, username }));
        return true;
      }
      return false;
    }

    function logout() {
      sessionStorage.removeItem(STORAGE_KEY);
    }

    function isLoggedIn() {
      const data = JSON.parse(sessionStorage.getItem(STORAGE_KEY));
      return data?.loggedIn === true;
    }

    function getUsername() {
      const data = JSON.parse(sessionStorage.getItem(STORAGE_KEY));
      return data?.username || null;
    }

    return { authenticate, logout, isLoggedIn, getUsername };
  })();

  // --- CASE MODEL ---
  const CaseModel = (() => {
    function createCase({
      id,
      type,
      status = 'Open',
      officer = 'Unassigned',
      dueDate = '',
      followUp = false,
      banDuration = null,
      severity = null,
    }) {
      if (type === 'Blackreport') {
        if (banDuration == null || severity == null) {
          throw new Error('Blackreport case requires banDuration and severity');
        }
        return {
          id,
          type,
          status,
          officer,
          dueDate,
          followUp,
          banDuration,
          severity,
        };
      } else {
        return {
          id,
          type,
          status,
          officer,
          dueDate,
          followUp,
        };
      }
    }
    return { createCase };
  })();

  // --- CASE MANAGER ---
  const CaseManager = (() => {
    let cases = [];

    function init(savedCases = []) {
      cases = savedCases;
    }
    function save() {
      localStorage.setItem('ia_cases', JSON.stringify(cases));
    }

    function addCase(caseData) {
      if (cases.some(c => c.id.toLowerCase() === caseData.id.toLowerCase())) {
        throw new Error('Case ID must be unique');
      }
      cases.push(caseData);
      save();
    }
    function editCase(caseId, updatedData) {
      const idx = cases.findIndex(c => c.id === caseId);
      if (idx === -1) throw new Error('Case not found');
      cases[idx] = { ...cases[idx], ...updatedData };
      save();
    }
    function deleteCase(caseId) {
      cases = cases.filter(c => c.id !== caseId);
      save();
    }
    function getCases() {
      return [...cases];
    }
    function filterCases(criteria = {}) {
      return cases.filter(c => {
        if (criteria.status && c.status !== criteria.status) return false;
        if (criteria.type && c.type !== criteria.type) return false;
        if (criteria.officer && c.officer !== criteria.officer) return false;
        return true;
      });
    }
    function searchCases(term) {
      if (!term) return getCases();
      term = term.toLowerCase();
      return cases.filter(c =>
        c.id.toLowerCase().includes(term) ||
        c.type.toLowerCase().includes(term) ||
        (c.status && c.status.toLowerCase().includes(term)) ||
        (c.officer && c.officer.toLowerCase().includes(term))
      );
    }
    return { init, addCase, editCase, deleteCase, getCases, filterCases, searchCases };
  })();

  // --- OFFICER MANAGER ---
  const OfficerManager = (() => {
    let officers = [];

    function init(savedOfficers = []) {
      officers = savedOfficers;
    }
    function save() {
      localStorage.setItem('ia_officers', JSON.stringify(officers));
    }
    function addOfficer(name) {
      if (!name.trim()) throw new Error('Officer name required');
      if (officers.includes(name)) throw new Error('Officer already exists');
      officers.push(name);
      save();
    }
    function removeOfficer(name) {
      officers = officers.filter(o => o !== name);
      save();
    }
    function getOfficers() {
      return [...officers];
    }
    return { init, addOfficer, removeOfficer, getOfficers };
  })();

  // --- LEADERBOARD ---
  const Leaderboard = (() => {
    function calculate(cases, officers) {
      const stats = officers.map(name => {
        const assigned = cases.filter(c => c.officer === name);
        const assignedCount = assigned.length;
        const completedCount = assigned.filter(c => ['Resolved', 'Closed'].includes(c.status)).length;
        const efficiency = assignedCount === 0 ? 0 : completedCount / assignedCount;
        return { officer: name, assignedCount, completedCount, efficiency };
      });
      stats.sort((a, b) => b.efficiency - a.efficiency || b.assignedCount - a.assignedCount);
      return stats;
    }
    return { calculate };
  })();

  // --- UI & App Logic ---
  const app = (() => {
    // Cache DOM
    const loginContainer = document.getElementById('login-container');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    const appContainer = document.getElementById('app');
    const logoutBtn = document.getElementById('logout-btn');

    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');

    const casesTableBody = document.getElementById('cases-tbody');
    const caseForm = document.getElementById('case-form');
    const formTitle = document.getElementById('form-title');
    const formSubmit = document.getElementById('form-submit');
    const formCancel = document.getElementById('form-cancel');

    const filterType = document.getElementById('filter-type');
    const filterStatus = document.getElementById('filter-status');
    const filterOfficer = document.getElementById('filter-officer');
    const caseSearch = document.getElementById('case-search');
    const clearFilters = document.getElementById('clear-filters');

    const breakdownContainer = document.getElementById('breakdown-container');

    const officerList = document.getElementById('officer-list');
    const officerForm = document.getElementById('officer-form');
    const officerNameInput = document.getElementById('officer-name');

    // Case form inputs
    const caseIdInput = document.getElementById('case-id');
    const caseTypeSelect = document.getElementById('case-type');
    const caseStatusSelect = document.getElementById('case-status');
    const caseOfficerInput = document.getElementById('case-officer');
    const caseDueInput = document.getElementById('case-due');
    const caseFollowupCheckbox = document.getElementById('case-followup');
    const blackreportFields = document.getElementById('blackreport-fields');
    const caseBanDurationInput = document.getElementById('case-ban-duration');
    const caseSeveritySelect = document.getElementById('case-severity');

    const leaderboardBody = document.getElementById('leaderboard-body');

    let editingIndex = -1;

    // Util: Format date YYYY-MM-DD => readable
    function formatDate(d) {
      if (!d) return '';
      const date = new Date(d);
      return date.toLocaleDateString();
    }

    // --- Render Functions ---
    function renderCasesTable(cases) {
      casesTableBody.innerHTML = '';
      if (cases.length === 0) {
        casesTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; font-style: italic;">No cases found.</td></tr>`;
        return;
      }
      cases.forEach(c => {
        const tr = document.createElement('tr');

        // Case ID
        const tdId = document.createElement('td');
        tdId.textContent = c.id;
        tdId.setAttribute('data-label', 'Case ID');
        tr.appendChild(tdId);

        // Type
        const tdType = document.createElement('td');
        tdType.textContent = c.type;
        tdType.setAttribute('data-label', 'Type');
        tr.appendChild(tdType);

        // Status with badge
        const tdStatus = document.createElement('td');
        tdStatus.setAttribute('data-label', 'Status');
        const spanBadge = document.createElement('span');
        spanBadge.classList.add('badge');
        spanBadge.textContent = c.status;
        switch (c.status.toLowerCase()) {
          case 'open': spanBadge.classList.add('open'); break;
          case 'pending': spanBadge.classList.add('pending'); break;
          case 'resolved': spanBadge.classList.add('resolved'); break;
          case 'closed': spanBadge.classList.add('closed'); break;
          default: spanBadge.style.backgroundColor = '#b22222';
        }
        tdStatus.appendChild(spanBadge);
        tr.appendChild(tdStatus);

        // Officer
        const tdOfficer = document.createElement('td');
        tdOfficer.textContent = c.officer;
        tdOfficer.setAttribute('data-label', 'Assigned Officer');
        tr.appendChild(tdOfficer);

        // Due Date
        const tdDue = document.createElement('td');
        tdDue.textContent = formatDate(c.dueDate);
        tdDue.setAttribute('data-label', 'Due Date');
        tr.appendChild(tdDue);

        // Follow-up
        const tdFollowup = document.createElement('td');
        tdFollowup.textContent = c.followUp ? 'Yes' : 'No';
        tdFollowup.setAttribute('data-label', 'Follow-up');
        tr.appendChild(tdFollowup);

        // Actions
        const tdActions = document.createElement('td');
        tdActions.setAttribute('data-label', 'Actions');
        // Edit button
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Edit';
        btnEdit.setAttribute('aria-label', `Edit case ${c.id}`);
        btnEdit.addEventListener('click', () => startEditCase(c.id));
        tdActions.appendChild(btnEdit);

        // Delete button
        const btnDelete = document.createElement('button');
        btnDelete.textContent = 'Delete';
        btnDelete.style.marginLeft = '6px';
        btnDelete.setAttribute('aria-label', `Delete case ${c.id}`);
        btnDelete.addEventListener('click', () => {
          if (confirm(`Delete case "${c.id}"? This action cannot be undone.`)) {
            CaseManager.deleteCase(c.id);
            renderAll();
          }
        });
        tdActions.appendChild(btnDelete);

        tr.appendChild(tdActions);
        casesTableBody.appendChild(tr);
      });
    }

    function renderOfficers() {
      const officers = OfficerManager.getOfficers();
      officerList.innerHTML = '';
      if (officers.length === 0) {
        officerList.innerHTML = '<li>No officers added yet.</li>';
      } else {
        officers.forEach(o => {
          const li = document.createElement('li');
          li.textContent = o;
          const btnDel = document.createElement('button');
          btnDel.textContent = 'Remove';
          btnDel.setAttribute('aria-label', `Remove officer ${o}`);
          btnDel.addEventListener('click', () => {
            if (confirm(`Remove officer "${o}"? All cases assigned to them will remain.`)) {
              OfficerManager.removeOfficer(o);
              renderAll();
            }
          });
          li.appendChild(btnDel);
          officerList.appendChild(li);
        });
      }
      // Update officer filter dropdown
      populateOfficerFilter(officers);
    }

    function populateOfficerFilter(officers) {
      filterOfficer.innerHTML = '<option value="">All Officers</option>';
      officers.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o;
        opt.textContent = o;
        filterOfficer.appendChild(opt);
      });
    }

    function renderProgress() {
      const allCases = CaseManager.getCases();
      const total = allCases.length;
      const completed = allCases.filter(c => ['Resolved', 'Closed'].includes(c.status)).length;
      const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
      progressText.textContent = `${completed} of ${total} cases completed (${percent}%)`;
      progressBar.style.width = percent + '%';
      progressBar.setAttribute('aria-valuenow', percent);
    }

    function renderBreakdown() {
      const cases = CaseManager.getCases();
      const typeCounts = {};
      cases.forEach(c => {
        typeCounts[c.type] = (typeCounts[c.type] || 0) + 1;
      });
      const types = Object.keys(typeCounts).sort();
      if (types.length === 0) {
        breakdownContainer.innerHTML = '<p>No cases to display breakdown.</p>';
        return;
      }
      breakdownContainer.innerHTML = '';
      types.forEach(type => {
        const count = typeCounts[type];
        const percent = Math.round((count / cases.length) * 100);
        const item = document.createElement('div');
        item.className = 'breakdown-item';
        const label = document.createElement('div');
        label.className = 'breakdown-label';
        label.textContent = `${type} â€” ${count} cases (${percent}%)`;
        const bar = document.createElement('div');
        bar.className = 'breakdown-bar';
        bar.style.width = percent + '%';
        item.appendChild(label);
        item.appendChild(bar);
        breakdownContainer.appendChild(item);
      });
    }

    function renderLeaderboard() {
      const officers = OfficerManager.getOfficers();
      const cases = CaseManager.getCases();
      const stats = Leaderboard.calculate(cases, officers);
      leaderboardBody.innerHTML = '';
      if (stats.length === 0) {
        leaderboardBody.innerHTML = '<tr><td colspan="4" style="text-align:center; font-style:italic;">No officers yet.</td></tr>';
        return;
      }
      stats.forEach(({ officer, assignedCount, completedCount, efficiency }) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${officer}</td>
          <td>${assignedCount}</td>
          <td>${completedCount}</td>
          <td>${(efficiency * 100).toFixed(0)}%</td>
        `;
        leaderboardBody.appendChild(tr);
      });
    }

    // --- Form handling ---
    function clearCaseForm() {
      caseIdInput.value = '';
      caseTypeSelect.value = '';
      caseStatusSelect.value = '';
      caseOfficerInput.value = '';
      caseDueInput.value = '';
      caseFollowupCheckbox.checked = false;
      caseBanDurationInput.value = '';
      caseSeveritySelect.value = '';
      blackreportFields.style.display = 'none';
      editingIndex = -1;
      formTitle.textContent = 'Add New Case';
      formSubmit.textContent = 'Add Case';
      formCancel.style.display = 'none';
      caseIdInput.disabled = false;
    }

    function fillCaseForm(caseData) {
      caseIdInput.value = caseData.id;
      caseTypeSelect.value = caseData.type;
      caseStatusSelect.value = caseData.status;
      caseOfficerInput.value = caseData.officer;
      caseDueInput.value = caseData.dueDate;
      caseFollowupCheckbox.checked = caseData.followUp;
      if (caseData.type === 'Blackreport') {
        blackreportFields.style.display = 'block';
        caseBanDurationInput.value = caseData.banDuration || '';
        caseSeveritySelect.value = caseData.severity || '';
      } else {
        blackreportFields.style.display = 'none';
        caseBanDurationInput.value = '';
        caseSeveritySelect.value = '';
      }
      editingIndex = caseData.id;
      formTitle.textContent = `Edit Case ${caseData.id}`;
      formSubmit.textContent = 'Update Case';
      formCancel.style.display = 'inline-block';
      caseIdInput.disabled = true;
    }

    function startEditCase(caseId) {
      const cases = CaseManager.getCases();
      const caseData = cases.find(c => c.id === caseId);
      if (!caseData) {
        alert('Case not found.');
        return;
      }
      fillCaseForm(caseData);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function handleCaseTypeChange() {
      if (caseTypeSelect.value === 'Blackreport') {
        blackreportFields.style.display = 'block';
        caseBanDurationInput.required = true;
        caseSeveritySelect.required = true;
      } else {
        blackreportFields.style.display = 'none';
        caseBanDurationInput.required = false;
        caseSeveritySelect.required = false;
        caseBanDurationInput.value = '';
        caseSeveritySelect.value = '';
      }
    }

    // --- Main render/update function ---
    function renderAll() {
      const searchTerm = caseSearch.value.trim();
      const filterCrit = {
        type: filterType.value || null,
        status: filterStatus.value || null,
        officer: filterOfficer.value || null,
      };

      let filteredCases = CaseManager.getCases();

      if (searchTerm) {
        filteredCases = CaseManager.searchCases(searchTerm);
      }
      if (filterCrit.type || filterCrit.status || filterCrit.officer) {
        filteredCases = filteredCases.filter(c => {
          if (filterCrit.type && c.type !== filterCrit.type) return false;
          if (filterCrit.status && c.status !== filterCrit.status) return false;
          if (filterCrit.officer && c.officer !== filterCrit.officer) return false;
          return true;
        });
      }

      renderCasesTable(filteredCases);
      renderProgress();
      renderBreakdown();
      renderOfficers();
      renderLeaderboard();
    }

    // --- Event Listeners ---
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      loginError.textContent = '';
      const username = loginForm.username.value.trim();
      const password = loginForm.password.value.trim();
      if (LoginModule.authenticate(username, password)) {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        renderAll();
      } else {
        loginError.textContent = 'Invalid username or password.';
      }
    });

    logoutBtn.addEventListener('click', () => {
      if (confirm('Log out?')) {
        LoginModule.logout();
        appContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        loginForm.reset();
      }
    });

    caseForm.addEventListener('submit', e => {
      e.preventDefault();
      try {
        const newCase = CaseModel.createCase({
          id: caseIdInput.value.trim(),
          type: caseTypeSelect.value,
          status: caseStatusSelect.value,
          officer: caseOfficerInput.value.trim(),
          dueDate: caseDueInput.value,
          followUp: caseFollowupCheckbox.checked,
          banDuration: caseTypeSelect.value === 'Blackreport' ? Number(caseBanDurationInput.value) : null,
          severity: caseTypeSelect.value === 'Blackreport' ? caseSeveritySelect.value : null,
        });

        if (editingIndex === -1) {
          CaseManager.addCase(newCase);
          alert(`Case "${newCase.id}" added.`);
        } else {
          CaseManager.editCase(editingIndex, newCase);
          alert(`Case "${newCase.id}" updated.`);
        }
        clearCaseForm();
        renderAll();
      } catch (err) {
        alert(err.message);
      }
    });

    formCancel.addEventListener('click', () => {
      clearCaseForm();
    });

    caseTypeSelect.addEventListener('change', () => {
      handleCaseTypeChange();
    });

    filterType.addEventListener('change', renderAll);
    filterStatus.addEventListener('change', renderAll);
    filterOfficer.addEventListener('change', renderAll);
    caseSearch.addEventListener('input', () => {
      // Debounce not needed here for simplicity
      renderAll();
    });
    clearFilters.addEventListener('click', () => {
      filterType.value = '';
      filterStatus.value = '';
      filterOfficer.value = '';
      caseSearch.value = '';
      renderAll();
    });

    officerForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = officerNameInput.value.trim();
      if (!name) {
        alert('Officer name cannot be empty.');
        return;
      }
      try {
        OfficerManager.addOfficer(name);
        alert(`Officer "${name}" added.`);
        officerNameInput.value = '';
        renderAll();
      } catch (err) {
        alert(err.message);
      }
    });

    // --- Init on page load ---
    function init() {
      // Load saved data or init empty
      CaseManager.init(JSON.parse(localStorage.getItem('ia_cases')) || []);
      OfficerManager.init(JSON.parse(localStorage.getItem('ia_officers')) || []);

      if (LoginModule.isLoggedIn()) {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        renderAll();
      } else {
        loginContainer.style.display = 'block';
        appContainer.style.display = 'none';
      }
    }

    return { init };
  })();

  window.addEventListener('DOMContentLoaded', () => {
    app.init();
  });
</script>

</body>
</html>
